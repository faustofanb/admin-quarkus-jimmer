apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-gitops-repo
  namespace: tekton-pipelines
spec:
  params:
  - name: gitops-repo-url
    type: string
  - name: image-name
    type: string
  - name: image-tag
    type: string
  - name: overlay-path
    type: string
  - default: Tekton Bot
    name: git-username
    type: string
  - default: tekton@example.com
    name: git-email
    type: string
  steps:
  - env:
    - name: GITEA_USERNAME
      valueFrom:
        secretKeyRef:
          key: username
          name: gitea-credentials
    - name: GITEA_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: gitea-credentials
    image: alpine/git:latest
    name: clone-and-update
    script: |
      #!/bin/sh
      set -e
      git config --global user.name "$(params.git-username)"
      git config --global user.email "$(params.git-email)"

      REPO_URL="http://${GITEA_USERNAME}:${GITEA_TOKEN}@gitea-http.platform.svc.cluster.local:3000/gitea_admin/apps-deploy.git"

      echo "Cloning GitOps repository..."
      git clone $REPO_URL repo
      cd repo

      echo "Navigating to: $(params.overlay-path)"
      cd $(params.overlay-path)

      if [ ! -f kustomization.yaml ]; then
        echo "ERROR: kustomization.yaml not found!"
        exit 1
      fi

      echo "Updating image tag to $(params.image-tag)..."
      sed -i "s|newTag:.*|newTag: $(params.image-tag)|g" kustomization.yaml

      echo "Updated kustomization.yaml:"
      cat kustomization.yaml

      git add kustomization.yaml
      if git commit -m "chore: update image to $(params.image-tag)"; then
        echo "Pushing changes..."
        git push origin main
        echo "✅ GitOps repository updated"
      else
        echo "ℹ️  No changes"
      fi
    workingDir: $(workspaces.gitops-source.path)
  workspaces:
  - name: gitops-source
