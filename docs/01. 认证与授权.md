# ğŸ” è®¤è¯ä¸æˆæƒæ¨¡å—è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [æ¨¡å—æ¦‚è¿°](#1-æ¨¡å—æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
3. [ç›®å½•ç»“æ„](#3-ç›®å½•ç»“æ„)
4. [æ ¸å¿ƒé¢†åŸŸæ¨¡å‹](#4-æ ¸å¿ƒé¢†åŸŸæ¨¡å‹)
5. [è®¤è¯æ¨¡å—è¯¦ç»†è®¾è®¡](#5-è®¤è¯æ¨¡å—è¯¦ç»†è®¾è®¡)
6. [æˆæƒæ¨¡å—è¯¦ç»†è®¾è®¡](#6-æˆæƒæ¨¡å—è¯¦ç»†è®¾è®¡)
7. [åŸºç¡€è®¾æ–½å±‚è®¾è®¡](#7-åŸºç¡€è®¾æ–½å±‚è®¾è®¡)
8. [æ¥å£å±‚è®¾è®¡](#8-æ¥å£å±‚è®¾è®¡)
9. [ä¸ç°æœ‰ç»„ä»¶çš„é›†æˆ](#9-ä¸ç°æœ‰ç»„ä»¶çš„é›†æˆ)
10. [é…ç½®è¯´æ˜](#10-é…ç½®è¯´æ˜)

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 åŠŸèƒ½èŒƒå›´

| åŠŸèƒ½æ¨¡å— | æè¿° |
|---------|------|
| **è®¤è¯ï¼ˆAuthenticationï¼‰** | ç”¨æˆ·èº«ä»½éªŒè¯ï¼ŒåŒ…æ‹¬ç™»å½•ã€ç™»å‡ºã€Tokenç®¡ç†ã€åˆ·æ–°Tokenç­‰ |
| **æˆæƒï¼ˆAuthorizationï¼‰** | æƒé™æ§åˆ¶ï¼ŒåŒ…æ‹¬è§’è‰²æƒé™ã€æ•°æ®æƒé™ã€èµ„æºæƒé™æ ¡éªŒ |
| **ä¼šè¯ç®¡ç†** | åœ¨çº¿ç”¨æˆ·ç®¡ç†ã€ä¼šè¯è¿‡æœŸã€å¼ºåˆ¶ä¸‹çº¿ç­‰ |
| **å®‰å…¨å®¡è®¡** | ç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ã€å®‰å…¨äº‹ä»¶è®°å½• |

### 1.2 è®¾è®¡åŸåˆ™

- **Clean DDD**ï¼šä¸¥æ ¼éµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œé¢†åŸŸå±‚ä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶
- **CQRS**ï¼šå‘½ä»¤å’ŒæŸ¥è¯¢åˆ†ç¦»ï¼ŒCommand å¤„ç†å†™æ“ä½œï¼ŒQuery å¤„ç†è¯»æ“ä½œ
- **Event Sourcing**ï¼šå…³é”®å®‰å…¨äº‹ä»¶é€šè¿‡äº‹ä»¶æ€»çº¿å‘å¸ƒï¼Œæ”¯æŒå®¡è®¡è¿½è¸ª
- **é«˜å†…èšä½è€¦åˆ**ï¼šé€šè¿‡é—¨é¢æ¨¡å¼ç»Ÿä¸€å…¥å£ï¼Œå†…éƒ¨ç»„ä»¶èŒè´£å•ä¸€
- **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆJWTã€OAuth2ã€LDAPç­‰ï¼‰å’Œæˆæƒç­–ç•¥

---

## 2. æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Interfaces Layer (æ¥å£å±‚)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AuthResource   â”‚  â”‚  AuthFilter     â”‚  â”‚  PermissionInterceptor      â”‚  â”‚
â”‚  â”‚  (REST API)     â”‚  â”‚  (JWTæ ¡éªŒ)      â”‚  â”‚  (æƒé™æ ¡éªŒ)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                           â”‚
            â–¼                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Application Layer (åº”ç”¨å±‚)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          SecurityFacade (ç»Ÿä¸€é—¨é¢)                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ AuthService â”‚  â”‚PermService â”‚  â”‚SessionServiceâ”‚  â”‚ AuditService  â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚            â”‚     Command    â”‚     Query      â”‚                  â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚           â”‚
â”‚  â”‚ LoginCommand     â”‚  â”‚ PermissionQuery  â”‚ â”‚                  â”‚           â”‚
â”‚  â”‚ LogoutCommand    â”‚  â”‚ RoleQuery        â”‚ â”‚                  â”‚           â”‚
â”‚  â”‚ RefreshCommand   â”‚  â”‚ MenuQuery        â”‚ â”‚                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚                  â”‚
                                              â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Domain Layer (é¢†åŸŸå±‚)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Authentication  â”‚  â”‚ Authorization    â”‚  â”‚ Session                     â”‚  â”‚
â”‚  â”‚ Â·Authenticator  â”‚  â”‚ Â·PermChecker    â”‚  â”‚ Â·SessionManager             â”‚  â”‚
â”‚  â”‚ Â·TokenProvider  â”‚  â”‚ Â·DataScope      â”‚  â”‚ Â·OnlineUserRegistry         â”‚  â”‚
â”‚  â”‚ Â·CredValidator  â”‚  â”‚ Â·RoleResolver   â”‚  â”‚                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                           â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Security Value Objects                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ LoginInfo    â”‚ â”‚ TokenPair    â”‚ â”‚ Permission   â”‚ â”‚ OnlineUser    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Credential   â”‚ â”‚ TokenClaims  â”‚ â”‚ DataScope    â”‚ â”‚ SessionInfo   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                           â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Domain Events                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚LoginEvent    â”‚ â”‚LogoutEvent   â”‚ â”‚PermDenied   â”‚ â”‚SessionExpired â”‚  â”‚  â”‚
â”‚  â”‚  â”‚              â”‚ â”‚              â”‚ â”‚Event        â”‚ â”‚Event          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)      â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ JwtTokenProviderâ”‚  â”‚ RedisSession    â”‚  â”‚ MessagingFacade             â”‚  â”‚
â”‚  â”‚ BCryptEncoder   â”‚  â”‚ Manager         â”‚  â”‚ (Event Publishing)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SecurityRepo    â”‚  â”‚ CacheFacade     â”‚  â”‚ DistributedFacade           â”‚  â”‚
â”‚  â”‚ (User/Role/     â”‚  â”‚ (æƒé™ç¼“å­˜)      â”‚  â”‚ (Tokenå¹‚ç­‰ã€åˆ†å¸ƒå¼é”)       â”‚  â”‚
â”‚  â”‚  Permission)    â”‚  â”‚                 â”‚  â”‚                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶å…³ç³»

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚           SecurityFacade              â”‚
              â”‚  (ç»Ÿä¸€å®‰å…¨é—¨é¢ï¼Œå¯¹å¤–å”¯ä¸€å…¥å£)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚           â”‚           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼            â–¼           â–¼           â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthServiceâ”‚ â”‚PermServiceâ”‚ â”‚SessionSvcâ”‚ â”‚ AuditSvc â”‚ â”‚ TokenSvc â”‚
â”‚ è®¤è¯æœåŠ¡    â”‚ â”‚ æƒé™æœåŠ¡  â”‚ â”‚ ä¼šè¯æœåŠ¡  â”‚ â”‚ å®¡è®¡æœåŠ¡  â”‚ â”‚ TokenæœåŠ¡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚           â”‚           â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         åˆ©ç”¨å·²æœ‰åŸºç¡€è®¾æ–½              â”‚
              â”‚  CacheFacade / MessagingFacade /     â”‚
              â”‚  DistributedFacade / AsyncExecutor   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç›®å½•ç»“æ„

```
src/main/java/io/github/faustofan/admin/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ security/                          # å®‰å…¨é¢†åŸŸæ¨¡å—
â”‚       â”œâ”€â”€ authentication/                # è®¤è¯å­åŸŸ
â”‚       â”‚   â”œâ”€â”€ Authenticator.java         # è®¤è¯å™¨æ¥å£
â”‚       â”‚   â”œâ”€â”€ TokenProvider.java         # Tokenç”Ÿæˆå™¨æ¥å£
â”‚       â”‚   â”œâ”€â”€ CredentialValidator.java   # å‡­è¯éªŒè¯å™¨
â”‚       â”‚   â””â”€â”€ AuthenticationResult.java  # è®¤è¯ç»“æœ
â”‚       â”œâ”€â”€ authorization/                 # æˆæƒå­åŸŸ
â”‚       â”‚   â”œâ”€â”€ PermissionChecker.java     # æƒé™æ£€æŸ¥å™¨æ¥å£
â”‚       â”‚   â”œâ”€â”€ DataScopeHandler.java      # æ•°æ®æƒé™å¤„ç†å™¨
â”‚       â”‚   â””â”€â”€ RoleResolver.java          # è§’è‰²è§£æå™¨
â”‚       â”œâ”€â”€ session/                       # ä¼šè¯å­åŸŸ
â”‚       â”‚   â”œâ”€â”€ SessionManager.java        # ä¼šè¯ç®¡ç†å™¨æ¥å£
â”‚       â”‚   â””â”€â”€ OnlineUserRegistry.java    # åœ¨çº¿ç”¨æˆ·æ³¨å†Œè¡¨
â”‚       â”œâ”€â”€ event/                         # å®‰å…¨é¢†åŸŸäº‹ä»¶
â”‚       â”‚   â”œâ”€â”€ LoginEvent.java            # ç™»å½•äº‹ä»¶
â”‚       â”‚   â”œâ”€â”€ LogoutEvent.java           # ç™»å‡ºäº‹ä»¶
â”‚       â”‚   â”œâ”€â”€ PermissionDeniedEvent.java # æƒé™æ‹’ç»äº‹ä»¶
â”‚       â”‚   â””â”€â”€ SessionExpiredEvent.java   # ä¼šè¯è¿‡æœŸäº‹ä»¶
â”‚       â”œâ”€â”€ valueobject/                   # å€¼å¯¹è±¡
â”‚       â”‚   â”œâ”€â”€ LoginInfo.java             # ç™»å½•ä¿¡æ¯
â”‚       â”‚   â”œâ”€â”€ TokenPair.java             # Tokenå¯¹ï¼ˆaccess + refreshï¼‰
â”‚       â”‚   â”œâ”€â”€ TokenClaims.java           # Tokenå£°æ˜
â”‚       â”‚   â”œâ”€â”€ Permission.java            # æƒé™æ ‡è¯†
â”‚       â”‚   â”œâ”€â”€ OnlineUser.java            # åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
â”‚       â”‚   â””â”€â”€ Credential.java            # å‡­è¯ï¼ˆç”¨æˆ·åå¯†ç ï¼‰
â”‚       â”œâ”€â”€ constants/                     # å®‰å…¨å¸¸é‡
â”‚       â”‚   â”œâ”€â”€ SecurityConstants.java     # å®‰å…¨ç›¸å…³å¸¸é‡
â”‚       â”‚   â””â”€â”€ TokenType.java             # Tokenç±»å‹æšä¸¾
â”‚       â””â”€â”€ service/                       # é¢†åŸŸæœåŠ¡
â”‚           â”œâ”€â”€ AuthenticationService.java # è®¤è¯é¢†åŸŸæœåŠ¡
â”‚           â”œâ”€â”€ AuthorizationService.java  # æˆæƒé¢†åŸŸæœåŠ¡
â”‚           â””â”€â”€ SessionDomainService.java  # ä¼šè¯é¢†åŸŸæœåŠ¡
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ security/                          # å®‰å…¨åŸºç¡€è®¾æ–½å®ç°
â”‚       â”œâ”€â”€ jwt/                           # JWTå®ç°
â”‚       â”‚   â”œâ”€â”€ JwtTokenProvider.java      # JWT Tokenç”Ÿæˆå™¨
â”‚       â”‚   â”œâ”€â”€ JwtTokenParser.java        # JWT Tokenè§£æå™¨
â”‚       â”‚   â””â”€â”€ JwtConfig.java             # JWTé…ç½®
â”‚       â”œâ”€â”€ password/                      # å¯†ç å¤„ç†
â”‚       â”‚   â””â”€â”€ BCryptPasswordEncoder.java # BCryptå¯†ç ç¼–ç å™¨
â”‚       â”œâ”€â”€ session/                       # ä¼šè¯å®ç°
â”‚       â”‚   â””â”€â”€ RedisSessionManager.java   # Redisä¼šè¯ç®¡ç†å™¨
â”‚       â””â”€â”€ repository/                    # ä»“å‚¨å®ç°
â”‚           â”œâ”€â”€ SecurityRepository.java    # å®‰å…¨ä»“å‚¨æ¥å£
â”‚           â””â”€â”€ JimmerSecurityRepository.java # Jimmerå®ç°
â”‚
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â””â”€â”€ auth/                          # è®¤è¯å‘½ä»¤
â”‚   â”‚       â”œâ”€â”€ LoginCommand.java          # ç™»å½•å‘½ä»¤
â”‚   â”‚       â”œâ”€â”€ LogoutCommand.java         # ç™»å‡ºå‘½ä»¤
â”‚   â”‚       â”œâ”€â”€ RefreshTokenCommand.java   # åˆ·æ–°Tokenå‘½ä»¤
â”‚   â”‚       â””â”€â”€ AuthCommandHandler.java    # è®¤è¯å‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ query/
â”‚   â”‚   â””â”€â”€ auth/                          # è®¤è¯æŸ¥è¯¢
â”‚   â”‚       â”œâ”€â”€ CurrentUserQuery.java      # å½“å‰ç”¨æˆ·æŸ¥è¯¢
â”‚   â”‚       â”œâ”€â”€ PermissionQuery.java       # æƒé™æŸ¥è¯¢
â”‚   â”‚       â”œâ”€â”€ RoleQuery.java             # è§’è‰²æŸ¥è¯¢
â”‚   â”‚       â””â”€â”€ AuthQueryHandler.java      # è®¤è¯æŸ¥è¯¢å¤„ç†å™¨
â”‚   â””â”€â”€ rest/
â”‚       â””â”€â”€ auth/                          # RESTæ¥å£
â”‚           â””â”€â”€ AuthResource.java          # è®¤è¯RESTèµ„æº
â”‚
â””â”€â”€ shared/
    â””â”€â”€ security/                          # å…±äº«å®‰å…¨ç»„ä»¶
        â”œâ”€â”€ annotation/                    # å®‰å…¨æ³¨è§£
        â”‚   â”œâ”€â”€ RequiresAuthentication.java# éœ€è¦è®¤è¯
        â”‚   â”œâ”€â”€ RequiresPermission.java    # éœ€è¦æƒé™
        â”‚   â”œâ”€â”€ RequiresRole.java          # éœ€è¦è§’è‰²
        â”‚   â””â”€â”€ DataPermission.java        # æ•°æ®æƒé™
        â”œâ”€â”€ config/                        # å®‰å…¨é…ç½®
        â”‚   â””â”€â”€ SecurityConfig.java        # å®‰å…¨é…ç½®æ˜ å°„
        â”œâ”€â”€ filter/                        # è¿‡æ»¤å™¨
        â”‚   â”œâ”€â”€ AuthenticationFilter.java  # è®¤è¯è¿‡æ»¤å™¨
        â”‚   â””â”€â”€ PermissionFilter.java      # æƒé™è¿‡æ»¤å™¨
        â”œâ”€â”€ interceptor/                   # æ‹¦æˆªå™¨
        â”‚   â”œâ”€â”€ AuthenticationInterceptor.java  # è®¤è¯æ‹¦æˆªå™¨
        â”‚   â””â”€â”€ PermissionInterceptor.java      # æƒé™æ‹¦æˆªå™¨
        â”œâ”€â”€ facade/                        # é—¨é¢
        â”‚   â””â”€â”€ SecurityFacade.java        # å®‰å…¨ç»Ÿä¸€é—¨é¢
        â”œâ”€â”€ context/                       # å®‰å…¨ä¸Šä¸‹æ–‡
        â”‚   â””â”€â”€ SecurityContextHolder.java # å®‰å…¨ä¸Šä¸‹æ–‡æŒæœ‰è€…
        â”œâ”€â”€ exception/                     # å®‰å…¨å¼‚å¸¸
        â”‚   â”œâ”€â”€ AuthenticationException.java    # è®¤è¯å¼‚å¸¸
        â”‚   â”œâ”€â”€ AuthorizationException.java     # æˆæƒå¼‚å¸¸
        â”‚   â””â”€â”€ TokenExpiredException.java      # Tokenè¿‡æœŸå¼‚å¸¸
        â””â”€â”€ constants/                     # å®‰å…¨å¸¸é‡
            â””â”€â”€ SecurityErrorCode.java     # å®‰å…¨é”™è¯¯ç 
```

---

## 4. æ ¸å¿ƒé¢†åŸŸæ¨¡å‹

### 4.1 å€¼å¯¹è±¡

#### LoginInfoï¼ˆç™»å½•ä¿¡æ¯ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

import java.time.Instant;
import java.util.List;

/**
 * ç™»å½•ä¿¡æ¯å€¼å¯¹è±¡
 * <p>
 * å°è£…ç™»å½•æˆåŠŸåçš„ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…å«Tokenå¯¹ã€ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€æƒé™åˆ—è¡¨ç­‰ã€‚
 * è¯¥å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œçº¿ç¨‹å®‰å…¨ã€‚
 */
public record LoginInfo(
    Long userId,                    // ç”¨æˆ·ID
    String username,                // ç”¨æˆ·å
    String nickname,                // æ˜µç§°
    String avatar,                  // å¤´åƒ
    Long tenantId,                  // ç§Ÿæˆ·ID
    Long deptId,                    // éƒ¨é—¨ID
    List<String> roles,             // è§’è‰²ç¼–ç åˆ—è¡¨
    List<String> permissions,       // æƒé™æ ‡è¯†åˆ—è¡¨
    TokenPair tokenPair,            // Tokenå¯¹
    Instant loginTime               // ç™»å½•æ—¶é—´
) {
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜
     */
    public boolean isAdmin() {
        return roles != null && roles.contains("super_admin");
    }

    /**
     * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™
     */
    public boolean hasPermission(String permission) {
        return isAdmin() || (permissions != null && permissions.contains(permission));
    }
}
```

#### TokenPairï¼ˆTokenå¯¹ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

import java.time.Instant;

/**
 * Tokenå¯¹å€¼å¯¹è±¡
 * <p>
 * åŒ…å«è®¿é—®ä»¤ç‰Œï¼ˆaccessTokenï¼‰å’Œåˆ·æ–°ä»¤ç‰Œï¼ˆrefreshTokenï¼‰ã€‚
 * ç”¨äºåŒTokenæœºåˆ¶ï¼Œå®ç°æ— æ„Ÿåˆ·æ–°ã€‚
 */
public record TokenPair(
    String accessToken,             // è®¿é—®ä»¤ç‰Œ
    String refreshToken,            // åˆ·æ–°ä»¤ç‰Œ
    Instant accessTokenExpireTime,  // è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´
    Instant refreshTokenExpireTime  // åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´
) {
    /**
     * è®¿é—®ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
     */
    public boolean isAccessTokenExpired() {
        return Instant.now().isAfter(accessTokenExpireTime);
    }

    /**
     * åˆ·æ–°ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
     */
    public boolean isRefreshTokenExpired() {
        return Instant.now().isAfter(refreshTokenExpireTime);
    }
}
```

#### TokenClaimsï¼ˆTokenå£°æ˜ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

import java.time.Instant;
import java.util.List;

/**
 * Tokenå£°æ˜å€¼å¯¹è±¡
 * <p>
 * å°è£…JWT Tokenä¸­æºå¸¦çš„å£°æ˜ä¿¡æ¯ï¼Œç”¨äºåç»­çš„æƒé™æ ¡éªŒã€‚
 */
public record TokenClaims(
    Long userId,                    // ç”¨æˆ·ID
    String username,                // ç”¨æˆ·å
    Long tenantId,                  // ç§Ÿæˆ·ID
    String tokenType,               // Tokenç±»å‹ï¼ˆaccess/refreshï¼‰
    List<String> roles,             // è§’è‰²åˆ—è¡¨
    Instant issuedAt,               // ç­¾å‘æ—¶é—´
    Instant expiresAt               // è¿‡æœŸæ—¶é—´
) {
    /**
     * Tokenæ˜¯å¦è¿‡æœŸ
     */
    public boolean isExpired() {
        return Instant.now().isAfter(expiresAt);
    }
}
```

#### Permissionï¼ˆæƒé™æ ‡è¯†ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

/**
 * æƒé™æ ‡è¯†å€¼å¯¹è±¡
 * <p>
 * è¡¨ç¤ºç³»ç»Ÿä¸­çš„ä¸€ä¸ªæƒé™ç‚¹ï¼Œæ ¼å¼ä¸ºï¼šæ¨¡å—:èµ„æº:æ“ä½œ
 * ä¾‹å¦‚ï¼šsystem:user:create
 */
public record Permission(
    String module,                  // æ¨¡å—ï¼ˆå¦‚ systemï¼‰
    String resource,                // èµ„æºï¼ˆå¦‚ userï¼‰
    String action                   // æ“ä½œï¼ˆå¦‚ create/update/delete/queryï¼‰
) {
    /**
     * å®Œæ•´æƒé™æ ‡è¯†
     */
    public String getFullPermission() {
        return String.join(":", module, resource, action);
    }

    /**
     * ä»å­—ç¬¦ä¸²è§£ææƒé™
     */
    public static Permission fromString(String permission) {
        String[] parts = permission.split(":");
        if (parts.length != 3) {
            throw new IllegalArgumentException("Invalid permission format: " + permission);
        }
        return new Permission(parts[0], parts[1], parts[2]);
    }

    /**
     * é€šé…ç¬¦åŒ¹é…
     */
    public boolean matches(String pattern) {
        if ("*".equals(pattern) || "*:*:*".equals(pattern)) {
            return true;
        }
        String[] patternParts = pattern.split(":");
        if (patternParts.length != 3) {
            return false;
        }
        return matchPart(module, patternParts[0])
            && matchPart(resource, patternParts[1])
            && matchPart(action, patternParts[2]);
    }

    private boolean matchPart(String value, String pattern) {
        return "*".equals(pattern) || pattern.equals(value);
    }
}
```

#### OnlineUserï¼ˆåœ¨çº¿ç”¨æˆ·ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

import java.time.Instant;

/**
 * åœ¨çº¿ç”¨æˆ·å€¼å¯¹è±¡
 * <p>
 * å°è£…åœ¨çº¿ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼Œç”¨äºä¼šè¯ç®¡ç†å’Œåœ¨çº¿ç”¨æˆ·ç›‘æ§ã€‚
 */
public record OnlineUser(
    String sessionId,               // ä¼šè¯ID
    Long userId,                    // ç”¨æˆ·ID
    String username,                // ç”¨æˆ·å
    Long tenantId,                  // ç§Ÿæˆ·ID
    String clientIp,                // å®¢æˆ·ç«¯IP
    String userAgent,               // ç”¨æˆ·ä»£ç†
    Instant loginTime,              // ç™»å½•æ—¶é—´
    Instant lastAccessTime          // æœ€åè®¿é—®æ—¶é—´
) {
    /**
     * ä¼šè¯æ˜¯å¦æ´»è·ƒï¼ˆæœ€åè®¿é—®æ—¶é—´åœ¨æŒ‡å®šåˆ†é’Ÿå†…ï¼‰
     */
    public boolean isActive(int minutes) {
        return Instant.now().minusSeconds(minutes * 60L).isBefore(lastAccessTime);
    }

    /**
     * æ›´æ–°æœ€åè®¿é—®æ—¶é—´
     */
    public OnlineUser touch() {
        return new OnlineUser(
            sessionId, userId, username, tenantId,
            clientIp, userAgent, loginTime, Instant.now()
        );
    }
}
```

#### Credentialï¼ˆå‡­è¯ï¼‰

```java
package io.github.faustofan.admin.domain.security.valueobject;

/**
 * ç™»å½•å‡­è¯å€¼å¯¹è±¡
 * <p>
 * å°è£…ç”¨æˆ·ç™»å½•æ—¶æäº¤çš„å‡­è¯ä¿¡æ¯ã€‚
 */
public record Credential(
    String username,                // ç”¨æˆ·å
    String password,                // å¯†ç 
    String captchaCode,             // éªŒè¯ç 
    String captchaKey,              // éªŒè¯ç Key
    Long tenantId                   // ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰
) {
    /**
     * éªŒè¯å‡­è¯æ˜¯å¦å®Œæ•´
     */
    public boolean isComplete() {
        return username != null && !username.isBlank()
            && password != null && !password.isBlank();
    }
}
```

### 4.2 é¢†åŸŸäº‹ä»¶

#### LoginEventï¼ˆç™»å½•äº‹ä»¶ï¼‰

```java
package io.github.faustofan.admin.domain.security.event;

import io.github.faustofan.admin.shared.messaging.core.DomainEvent;
import java.time.Instant;

/**
 * ç”¨æˆ·ç™»å½•äº‹ä»¶
 * <p>
 * å½“ç”¨æˆ·æˆåŠŸç™»å½•æ—¶å‘å¸ƒæ­¤äº‹ä»¶ï¼Œç”¨äºï¼š
 * <ul>
 *   <li>è®°å½•ç™»å½•æ—¥å¿—</li>
 *   <li>æ›´æ–°ç”¨æˆ·æœ€åç™»å½•ä¿¡æ¯</li>
 *   <li>å‘é€ç™»å½•é€šçŸ¥</li>
 * </ul>
 */
public class LoginEvent extends DomainEvent<LoginEventPayload> {

    private LoginEvent(LoginEventPayload payload) {
        super(payload);
    }

    public static LoginEvent of(
        Long userId, String username, Long tenantId,
        String clientIp, String userAgent, boolean success, String failReason
    ) {
        return new LoginEvent(new LoginEventPayload(
            userId, username, tenantId, clientIp, userAgent,
            Instant.now(), success, failReason
        ));
    }
}

/**
 * ç™»å½•äº‹ä»¶è½½è·
 */
public record LoginEventPayload(
    Long userId,
    String username,
    Long tenantId,
    String clientIp,
    String userAgent,
    Instant loginTime,
    boolean success,
    String failReason
) {}
```

#### PermissionDeniedEventï¼ˆæƒé™æ‹’ç»äº‹ä»¶ï¼‰

```java
package io.github.faustofan.admin.domain.security.event;

import io.github.faustofan.admin.shared.messaging.core.DomainEvent;
import java.time.Instant;

/**
 * æƒé™æ‹’ç»äº‹ä»¶
 * <p>
 * å½“ç”¨æˆ·è®¿é—®å—é™èµ„æºè¢«æ‹’ç»æ—¶å‘å¸ƒæ­¤äº‹ä»¶ï¼Œç”¨äºï¼š
 * <ul>
 *   <li>å®‰å…¨å®¡è®¡</li>
 *   <li>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹</li>
 *   <li>å‘Šè­¦é€šçŸ¥</li>
 * </ul>
 */
public class PermissionDeniedEvent extends DomainEvent<PermissionDeniedPayload> {

    public static PermissionDeniedEvent of(
        Long userId, String requestUri, String requiredPermission
    ) {
        return new PermissionDeniedEvent(new PermissionDeniedPayload(
            userId, requestUri, requiredPermission, Instant.now()
        ));
    }
}

public record PermissionDeniedPayload(
    Long userId,
    String requestUri,
    String requiredPermission,
    Instant deniedAt
) {}
```

---

## 5. è®¤è¯æ¨¡å—è¯¦ç»†è®¾è®¡

### 5.1 è®¤è¯å™¨æ¥å£

```java
package io.github.faustofan.admin.domain.security.authentication;

import io.github.faustofan.admin.domain.security.valueobject.Credential;
import io.github.faustofan.admin.domain.security.valueobject.LoginInfo;

/**
 * è®¤è¯å™¨æ¥å£
 * <p>
 * å®šä¹‰ç”¨æˆ·èº«ä»½è®¤è¯çš„æ ¸å¿ƒå¥‘çº¦ã€‚æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆç”¨æˆ·åå¯†ç ã€OAuth2ã€LDAPç­‰ï¼‰ã€‚
 * 
 * <h3>å®ç°è¦æ±‚ï¼š</h3>
 * <ul>
 *   <li>éªŒè¯ç”¨æˆ·å‡­è¯çš„æœ‰æ•ˆæ€§</li>
 *   <li>éªŒè¯ç”¨æˆ·è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦å¯ç”¨ã€æ˜¯å¦é”å®šï¼‰</li>
 *   <li>éªŒè¯ç§Ÿæˆ·çŠ¶æ€ï¼ˆæ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦è¿‡æœŸï¼‰</li>
 *   <li>ç”Ÿæˆè®¤è¯Token</li>
 * </ul>
 */
public interface Authenticator {

    /**
     * æ‰§è¡Œèº«ä»½è®¤è¯
     *
     * @param credential ç”¨æˆ·å‡­è¯
     * @return è®¤è¯ç»“æœï¼ˆåŒ…å«Tokenå’Œç”¨æˆ·ä¿¡æ¯ï¼‰
     * @throws AuthenticationException è®¤è¯å¤±è´¥æ—¶æŠ›å‡º
     */
    AuthenticationResult authenticate(Credential credential);

    /**
     * æ”¯æŒçš„è®¤è¯ç±»å‹
     */
    String supportedType();
}
```

### 5.2 Tokenæä¾›è€…æ¥å£

```java
package io.github.faustofan.admin.domain.security.authentication;

import io.github.faustofan.admin.domain.security.valueobject.TokenClaims;
import io.github.faustofan.admin.domain.security.valueobject.TokenPair;

/**
 * Tokenæä¾›è€…æ¥å£
 * <p>
 * å®šä¹‰Tokenç”Ÿæˆå’Œè§£æçš„æ ¸å¿ƒå¥‘çº¦ã€‚
 *
 * <h3>èŒè´£ï¼š</h3>
 * <ul>
 *   <li>ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰</li>
 *   <li>ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰</li>
 *   <li>è§£æå¹¶éªŒè¯Token</li>
 *   <li>åˆ·æ–°Tokenå¯¹</li>
 * </ul>
 */
public interface TokenProvider {

    /**
     * ç”ŸæˆTokenå¯¹
     *
     * @param claims Tokenå£°æ˜
     * @return Tokenå¯¹ï¼ˆaccess + refreshï¼‰
     */
    TokenPair generateTokenPair(TokenClaims claims);

    /**
     * è§£æToken
     *
     * @param token JWTå­—ç¬¦ä¸²
     * @return Tokenå£°æ˜
     * @throws TokenExpiredException    Tokenè¿‡æœŸ
     * @throws InvalidTokenException    Tokenæ— æ•ˆ
     */
    TokenClaims parseToken(String token);

    /**
     * åˆ·æ–°Token
     *
     * @param refreshToken åˆ·æ–°ä»¤ç‰Œ
     * @return æ–°çš„Tokenå¯¹
     */
    TokenPair refreshToken(String refreshToken);

    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     *
     * @param token JWTå­—ç¬¦ä¸²
     * @return true-æœ‰æ•ˆï¼Œfalse-æ— æ•ˆ
     */
    boolean validateToken(String token);
}
```

### 5.3 è®¤è¯é¢†åŸŸæœåŠ¡

```java
package io.github.faustofan.admin.domain.security.service;

import io.github.faustofan.admin.domain.security.authentication.*;
import io.github.faustofan.admin.domain.security.event.LoginEvent;
import io.github.faustofan.admin.domain.security.event.LogoutEvent;
import io.github.faustofan.admin.domain.security.valueobject.*;
import io.github.faustofan.admin.shared.messaging.facade.MessagingFacade;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.jboss.logging.Logger;

/**
 * è®¤è¯é¢†åŸŸæœåŠ¡
 * <p>
 * ç¼–æ’è®¤è¯æµç¨‹ï¼Œåè°ƒè®¤è¯å™¨ã€Tokenæä¾›è€…ã€ä¼šè¯ç®¡ç†å™¨ç­‰ç»„ä»¶å®Œæˆè®¤è¯ã€‚
 *
 * <h3>æ ¸å¿ƒèŒè´£ï¼š</h3>
 * <ul>
 *   <li>ç”¨æˆ·ç™»å½•æµç¨‹ç¼–æ’</li>
 *   <li>ç”¨æˆ·ç™»å‡ºæµç¨‹ç¼–æ’</li>
 *   <li>Tokenåˆ·æ–°æµç¨‹ç¼–æ’</li>
 *   <li>å‘å¸ƒè®¤è¯ç›¸å…³é¢†åŸŸäº‹ä»¶</li>
 * </ul>
 */
@ApplicationScoped
public class AuthenticationService {

    private static final Logger LOG = Logger.getLogger(AuthenticationService.class);

    @Inject
    Authenticator authenticator;

    @Inject
    TokenProvider tokenProvider;

    @Inject
    SessionManager sessionManager;

    @Inject
    MessagingFacade messagingFacade;

    /**
     * ç”¨æˆ·ç™»å½•
     *
     * @param credential ç™»å½•å‡­è¯
     * @param clientIp   å®¢æˆ·ç«¯IP
     * @param userAgent  ç”¨æˆ·ä»£ç†
     * @return ç™»å½•ä¿¡æ¯
     */
    public LoginInfo login(Credential credential, String clientIp, String userAgent) {
        LOG.infov("User login attempt: username={0}, tenantId={1}",
            credential.username(), credential.tenantId());

        try {
            // 1. æ‰§è¡Œè®¤è¯
            AuthenticationResult result = authenticator.authenticate(credential);

            // 2. ç”ŸæˆToken
            TokenClaims claims = buildTokenClaims(result);
            TokenPair tokenPair = tokenProvider.generateTokenPair(claims);

            // 3. åˆ›å»ºä¼šè¯
            OnlineUser onlineUser = OnlineUser.create(
                result.userId(), result.username(), result.tenantId(),
                clientIp, userAgent
            );
            sessionManager.createSession(onlineUser);

            // 4. æ„å»ºç™»å½•ä¿¡æ¯
            LoginInfo loginInfo = buildLoginInfo(result, tokenPair);

            // 5. å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶
            publishLoginEvent(result, clientIp, userAgent, true, null);

            LOG.infov("User login success: userId={0}, username={1}",
                result.userId(), result.username());

            return loginInfo;

        } catch (Exception e) {
            // å‘å¸ƒç™»å½•å¤±è´¥äº‹ä»¶
            publishLoginEvent(null, clientIp, userAgent, false, e.getMessage());
            throw e;
        }
    }

    /**
     * ç”¨æˆ·ç™»å‡º
     *
     * @param sessionId ä¼šè¯ID
     */
    public void logout(String sessionId) {
        LOG.infov("User logout: sessionId={0}", sessionId);

        // 1. è·å–å¹¶éªŒè¯ä¼šè¯
        OnlineUser onlineUser = sessionManager.getSession(sessionId)
            .orElseThrow(() -> new SessionNotFoundException("Session not found"));

        // 2. é”€æ¯ä¼šè¯
        sessionManager.destroySession(sessionId);

        // 3. å‘å¸ƒç™»å‡ºäº‹ä»¶
        messagingFacade.publish(LogoutEvent.of(
            onlineUser.userId(), onlineUser.username(), onlineUser.tenantId()
        ));

        LOG.infov("User logout success: userId={0}", onlineUser.userId());
    }

    /**
     * åˆ·æ–°Token
     *
     * @param refreshToken åˆ·æ–°ä»¤ç‰Œ
     * @return æ–°çš„Tokenå¯¹
     */
    public TokenPair refreshToken(String refreshToken) {
        LOG.debug("Refreshing token");

        // 1. éªŒè¯åˆ·æ–°ä»¤ç‰Œ
        TokenClaims claims = tokenProvider.parseToken(refreshToken);
        if (!"refresh".equals(claims.tokenType())) {
            throw new InvalidTokenException("Invalid refresh token type");
        }

        // 2. éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
        boolean sessionExists = sessionManager.existsByUserId(claims.userId());
        if (!sessionExists) {
            throw new SessionNotFoundException("Session expired, please login again");
        }

        // 3. ç”Ÿæˆæ–°çš„Tokenå¯¹
        return tokenProvider.refreshToken(refreshToken);
    }

    // ===========================
    // ç§æœ‰è¾…åŠ©æ–¹æ³•
    // ===========================

    private TokenClaims buildTokenClaims(AuthenticationResult result) {
        return new TokenClaims(
            result.userId(),
            result.username(),
            result.tenantId(),
            "access",
            result.roles(),
            Instant.now(),
            null  // ç”±TokenProviderè®¾ç½®è¿‡æœŸæ—¶é—´
        );
    }

    private LoginInfo buildLoginInfo(AuthenticationResult result, TokenPair tokenPair) {
        return new LoginInfo(
            result.userId(),
            result.username(),
            result.nickname(),
            result.avatar(),
            result.tenantId(),
            result.deptId(),
            result.roles(),
            result.permissions(),
            tokenPair,
            Instant.now()
        );
    }

    private void publishLoginEvent(
        AuthenticationResult result, String clientIp, String userAgent,
        boolean success, String failReason
    ) {
        messagingFacade.publish(LoginEvent.of(
            result != null ? result.userId() : null,
            result != null ? result.username() : null,
            result != null ? result.tenantId() : null,
            clientIp, userAgent, success, failReason
        ));
    }
}
```

---

## 6. æˆæƒæ¨¡å—è¯¦ç»†è®¾è®¡

### 6.1 æƒé™æ£€æŸ¥å™¨æ¥å£

```java
package io.github.faustofan.admin.domain.security.authorization;

import java.util.List;

/**
 * æƒé™æ£€æŸ¥å™¨æ¥å£
 * <p>
 * å®šä¹‰æƒé™æ ¡éªŒçš„æ ¸å¿ƒå¥‘çº¦ï¼Œæ”¯æŒå¤šç§æƒé™æ£€æŸ¥ç­–ç•¥ã€‚
 *
 * <h3>æ”¯æŒçš„æ£€æŸ¥ç±»å‹ï¼š</h3>
 * <ul>
 *   <li>å•ä¸€æƒé™æ£€æŸ¥</li>
 *   <li>å¤šæƒé™ä¸ï¼ˆANDï¼‰æ£€æŸ¥</li>
 *   <li>å¤šæƒé™æˆ–ï¼ˆORï¼‰æ£€æŸ¥</li>
 *   <li>è§’è‰²æ£€æŸ¥</li>
 * </ul>
 */
public interface PermissionChecker {

    /**
     * æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™
     *
     * @param userId     ç”¨æˆ·ID
     * @param permission æƒé™æ ‡è¯†
     * @return true-æ‹¥æœ‰æƒé™ï¼Œfalse-æ— æƒé™
     */
    boolean hasPermission(Long userId, String permission);

    /**
     * æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰ä»»ä¸€æƒé™ï¼ˆORé€»è¾‘ï¼‰
     *
     * @param userId      ç”¨æˆ·ID
     * @param permissions æƒé™åˆ—è¡¨
     * @return true-æ‹¥æœ‰ä»»ä¸€æƒé™
     */
    boolean hasAnyPermission(Long userId, List<String> permissions);

    /**
     * æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆANDé€»è¾‘ï¼‰
     *
     * @param userId      ç”¨æˆ·ID
     * @param permissions æƒé™åˆ—è¡¨
     * @return true-æ‹¥æœ‰æ‰€æœ‰æƒé™
     */
    boolean hasAllPermissions(Long userId, List<String> permissions);

    /**
     * æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŒ‡å®šè§’è‰²
     *
     * @param userId   ç”¨æˆ·ID
     * @param roleCode è§’è‰²ç¼–ç 
     * @return true-æ‹¥æœ‰è§’è‰²
     */
    boolean hasRole(Long userId, String roleCode);

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
     *
     * @param userId ç”¨æˆ·ID
     * @return true-æ˜¯è¶…çº§ç®¡ç†å‘˜
     */
    boolean isSuperAdmin(Long userId);

    /**
     * è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
     *
     * @param userId ç”¨æˆ·ID
     * @return æƒé™æ ‡è¯†åˆ—è¡¨
     */
    List<String> getUserPermissions(Long userId);

    /**
     * è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰²
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²ç¼–ç åˆ—è¡¨
     */
    List<String> getUserRoles(Long userId);
}
```

### 6.2 æ•°æ®æƒé™å¤„ç†å™¨

```java
package io.github.faustofan.admin.domain.security.authorization;

import io.github.faustofan.admin.domain.constants.DataScope;
import java.util.List;

/**
 * æ•°æ®æƒé™å¤„ç†å™¨æ¥å£
 * <p>
 * å®šä¹‰æ•°æ®æƒé™è¿‡æ»¤çš„æ ¸å¿ƒå¥‘çº¦ï¼Œå®ç°è¡Œçº§æ•°æ®æƒé™æ§åˆ¶ã€‚
 *
 * <h3>æ”¯æŒçš„æ•°æ®èŒƒå›´ï¼š</h3>
 * <ul>
 *   <li>ALL - å…¨éƒ¨æ•°æ®æƒé™</li>
 *   <li>CUSTOM - è‡ªå®šä¹‰æ•°æ®æƒé™ï¼ˆæŒ‡å®šéƒ¨é—¨ï¼‰</li>
 *   <li>DEPT - æœ¬éƒ¨é—¨æ•°æ®æƒé™</li>
 *   <li>DEPT_AND_CHILD - æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™</li>
 *   <li>SELF - ä»…æœ¬äººæ•°æ®æƒé™</li>
 * </ul>
 */
public interface DataScopeHandler {

    /**
     * è·å–ç”¨æˆ·æ•°æ®æƒé™èŒƒå›´
     *
     * @param userId ç”¨æˆ·ID
     * @return æ•°æ®æƒé™èŒƒå›´
     */
    DataScope getDataScope(Long userId);

    /**
     * è·å–ç”¨æˆ·å¯è®¿é—®çš„éƒ¨é—¨IDåˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return éƒ¨é—¨IDåˆ—è¡¨
     */
    List<Long> getAccessibleDeptIds(Long userId);

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯è®¿é—®æŒ‡å®šéƒ¨é—¨æ•°æ®
     *
     * @param userId ç”¨æˆ·ID
     * @param deptId éƒ¨é—¨ID
     * @return true-å¯è®¿é—®
     */
    boolean canAccessDept(Long userId, Long deptId);

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯è®¿é—®æŒ‡å®šç”¨æˆ·æ•°æ®
     *
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @param targetUserId  ç›®æ ‡ç”¨æˆ·ID
     * @return true-å¯è®¿é—®
     */
    boolean canAccessUser(Long currentUserId, Long targetUserId);

    /**
     * ç”Ÿæˆæ•°æ®æƒé™SQLç‰‡æ®µ
     * <p>
     * ç”¨äºåœ¨æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿½åŠ æ•°æ®æƒé™è¿‡æ»¤æ¡ä»¶
     *
     * @param userId      ç”¨æˆ·ID
     * @param tableAlias  è¡¨åˆ«å
     * @param deptColumn  éƒ¨é—¨IDåˆ—å
     * @param userColumn  ç”¨æˆ·IDåˆ—å
     * @return SQLç‰‡æ®µï¼ˆå¦‚ "AND dept_id IN (1,2,3)"ï¼‰
     */
    String generateDataScopeSql(Long userId, String tableAlias, String deptColumn, String userColumn);
}
```

### 6.3 æˆæƒé¢†åŸŸæœåŠ¡

```java
package io.github.faustofan.admin.domain.security.service;

import io.github.faustofan.admin.domain.security.authorization.*;
import io.github.faustofan.admin.domain.security.event.PermissionDeniedEvent;
import io.github.faustofan.admin.shared.cache.facade.CacheFacade;
import io.github.faustofan.admin.shared.messaging.facade.MessagingFacade;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.jboss.logging.Logger;

import java.time.Duration;
import java.util.List;

/**
 * æˆæƒé¢†åŸŸæœåŠ¡
 * <p>
 * ç¼–æ’æˆæƒæµç¨‹ï¼Œæ•´åˆæƒé™æ£€æŸ¥ã€æ•°æ®æƒé™ã€è§’è‰²è§£æç­‰èƒ½åŠ›ã€‚
 *
 * <h3>æ ¸å¿ƒèŒè´£ï¼š</h3>
 * <ul>
 *   <li>æƒé™æ ¡éªŒï¼ˆå¸¦ç¼“å­˜ï¼‰</li>
 *   <li>æ•°æ®æƒé™è¿‡æ»¤</li>
 *   <li>æƒé™æ‹’ç»äº‹ä»¶å‘å¸ƒ</li>
 * </ul>
 */
@ApplicationScoped
public class AuthorizationService {

    private static final Logger LOG = Logger.getLogger(AuthorizationService.class);

    /** æƒé™ç¼“å­˜Keyå‰ç¼€ */
    private static final String PERM_CACHE_KEY = "security:permission:";

    /** æƒé™ç¼“å­˜TTL */
    private static final Duration PERM_CACHE_TTL = Duration.ofMinutes(30);

    @Inject
    PermissionChecker permissionChecker;

    @Inject
    DataScopeHandler dataScopeHandler;

    @Inject
    CacheFacade cacheFacade;

    @Inject
    MessagingFacade messagingFacade;

    /**
     * æ£€æŸ¥æƒé™ï¼ˆå¸¦ç¼“å­˜ï¼‰
     *
     * @param userId     ç”¨æˆ·ID
     * @param permission æƒé™æ ‡è¯†
     * @return true-æ‹¥æœ‰æƒé™
     */
    public boolean checkPermission(Long userId, String permission) {
        // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        if (permissionChecker.isSuperAdmin(userId)) {
            return true;
        }

        // ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
        List<String> permissions = getUserPermissionsFromCache(userId);

        // æ£€æŸ¥æƒé™
        boolean hasPermission = permissions.contains(permission)
            || permissions.stream().anyMatch(p -> matchPermission(p, permission));

        if (!hasPermission) {
            LOG.warnv("Permission denied: userId={0}, permission={1}", userId, permission);
        }

        return hasPermission;
    }

    /**
     * æ£€æŸ¥æƒé™å¹¶æŠ›å‡ºå¼‚å¸¸
     *
     * @param userId      ç”¨æˆ·ID
     * @param permission  æƒé™æ ‡è¯†
     * @param requestUri  è¯·æ±‚URIï¼ˆç”¨äºå®¡è®¡ï¼‰
     * @throws AuthorizationException æ— æƒé™æ—¶æŠ›å‡º
     */
    public void requirePermission(Long userId, String permission, String requestUri) {
        if (!checkPermission(userId, permission)) {
            // å‘å¸ƒæƒé™æ‹’ç»äº‹ä»¶
            messagingFacade.publish(PermissionDeniedEvent.of(userId, requestUri, permission));
            throw new AuthorizationException("Permission denied: " + permission);
        }
    }

    /**
     * æ£€æŸ¥è§’è‰²ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public boolean checkRole(Long userId, String roleCode) {
        if (permissionChecker.isSuperAdmin(userId)) {
            return true;
        }
        return permissionChecker.hasRole(userId, roleCode);
    }

    /**
     * è·å–ç”¨æˆ·å¯è®¿é—®çš„éƒ¨é—¨IDåˆ—è¡¨
     */
    public List<Long> getAccessibleDeptIds(Long userId) {
        return dataScopeHandler.getAccessibleDeptIds(userId);
    }

    /**
     * æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜ï¼ˆè§’è‰²/æƒé™å˜æ›´æ—¶è°ƒç”¨ï¼‰
     */
    public void clearPermissionCache(Long userId) {
        cacheFacade.invalidate(PERM_CACHE_KEY + userId);
        LOG.infov("Permission cache cleared: userId={0}", userId);
    }

    // ===========================
    // ç§æœ‰è¾…åŠ©æ–¹æ³•
    // ===========================

    @SuppressWarnings("unchecked")
    private List<String> getUserPermissionsFromCache(Long userId) {
        String cacheKey = PERM_CACHE_KEY + userId;
        return cacheFacade.getOrLoad(
            cacheKey,
            List.class,
            () -> permissionChecker.getUserPermissions(userId),
            PERM_CACHE_TTL
        );
    }

    /**
     * æƒé™é€šé…ç¬¦åŒ¹é…
     * <p>
     * æ”¯æŒ * é€šé…ç¬¦ï¼Œå¦‚ system:user:* åŒ¹é… system:user:create
     */
    private boolean matchPermission(String pattern, String permission) {
        if (pattern.equals(permission)) {
            return true;
        }
        if (pattern.contains("*")) {
            String regex = pattern.replace("*", ".*");
            return permission.matches(regex);
        }
        return false;
    }
}
```

---

## 7. åŸºç¡€è®¾æ–½å±‚è®¾è®¡

### 7.1 JWT Tokenæä¾›è€…å®ç°

```java
package io.github.faustofan.admin.infrastructure.security.jwt;

import io.github.faustofan.admin.domain.security.authentication.TokenProvider;
import io.github.faustofan.admin.domain.security.valueobject.TokenClaims;
import io.github.faustofan.admin.domain.security.valueobject.TokenPair;
import io.github.faustofan.admin.shared.security.exception.InvalidTokenException;
import io.github.faustofan.admin.shared.security.exception.TokenExpiredException;
import io.smallrye.jwt.build.Jwt;
import io.smallrye.jwt.build.JwtClaimsBuilder;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.eclipse.microprofile.jwt.JsonWebToken;
import org.jboss.logging.Logger;

import java.time.Duration;
import java.time.Instant;
import java.util.List;

/**
 * JWT Tokenæä¾›è€…å®ç°
 * <p>
 * åŸºäº SmallRye JWT å®ç°Tokençš„ç”Ÿæˆå’Œè§£æã€‚
 *
 * <h3>ç‰¹æ€§ï¼š</h3>
 * <ul>
 *   <li>åŒTokenæœºåˆ¶ï¼ˆAccess + Refreshï¼‰</li>
 *   <li>RS256 éå¯¹ç§°åŠ å¯†ç­¾å</li>
 *   <li>æ”¯æŒTokenåˆ·æ–°</li>
 * </ul>
 */
@ApplicationScoped
public class JwtTokenProvider implements TokenProvider {

    private static final Logger LOG = Logger.getLogger(JwtTokenProvider.class);

    @Inject
    JwtConfig jwtConfig;

    @Inject
    JwtTokenParser jwtTokenParser;

    @Override
    public TokenPair generateTokenPair(TokenClaims claims) {
        LOG.debugv("Generating token pair for user: {0}", claims.userId());

        Instant now = Instant.now();

        // ç”ŸæˆAccess Token
        Instant accessExpireTime = now.plus(jwtConfig.accessTokenExpiration());
        String accessToken = buildToken(claims, "access", accessExpireTime);

        // ç”ŸæˆRefresh Token
        Instant refreshExpireTime = now.plus(jwtConfig.refreshTokenExpiration());
        String refreshToken = buildToken(claims, "refresh", refreshExpireTime);

        return new TokenPair(accessToken, refreshToken, accessExpireTime, refreshExpireTime);
    }

    @Override
    public TokenClaims parseToken(String token) {
        try {
            JsonWebToken jwt = jwtTokenParser.parse(token);

            return new TokenClaims(
                jwt.getClaim("userId"),
                jwt.getClaim("username"),
                jwt.getClaim("tenantId"),
                jwt.getClaim("tokenType"),
                jwt.getGroups().stream().toList(),
                Instant.ofEpochSecond(jwt.getIssuedAtTime()),
                Instant.ofEpochSecond(jwt.getExpirationTime())
            );
        } catch (Exception e) {
            LOG.warnv("Failed to parse token: {0}", e.getMessage());
            throw new InvalidTokenException("Invalid token", e);
        }
    }

    @Override
    public TokenPair refreshToken(String refreshToken) {
        TokenClaims claims = parseToken(refreshToken);

        if (claims.isExpired()) {
            throw new TokenExpiredException("Refresh token expired");
        }

        if (!"refresh".equals(claims.tokenType())) {
            throw new InvalidTokenException("Invalid token type for refresh");
        }

        return generateTokenPair(claims);
    }

    @Override
    public boolean validateToken(String token) {
        try {
            TokenClaims claims = parseToken(token);
            return !claims.isExpired();
        } catch (Exception e) {
            return false;
        }
    }

    // ===========================
    // ç§æœ‰è¾…åŠ©æ–¹æ³•
    // ===========================

    private String buildToken(TokenClaims claims, String tokenType, Instant expireTime) {
        JwtClaimsBuilder builder = Jwt.claims()
            .issuer(jwtConfig.issuer())
            .subject(claims.username())
            .issuedAt(Instant.now())
            .expiresAt(expireTime)
            .claim("userId", claims.userId())
            .claim("username", claims.username())
            .claim("tenantId", claims.tenantId())
            .claim("tokenType", tokenType);

        // æ·»åŠ è§’è‰²
        if (claims.roles() != null && !claims.roles().isEmpty()) {
            builder.groups(claims.roles().stream().collect(java.util.stream.Collectors.toSet()));
        }

        return builder.sign();
    }
}
```

### 7.2 Redisä¼šè¯ç®¡ç†å™¨å®ç°

```java
package io.github.faustofan.admin.infrastructure.security.session;

import io.github.faustofan.admin.domain.security.session.SessionManager;
import io.github.faustofan.admin.domain.security.valueobject.OnlineUser;
import io.github.faustofan.admin.shared.cache.facade.CacheFacade;
import io.github.faustofan.admin.shared.distributed.facade.DistributedFacade;
import io.github.faustofan.admin.shared.security.config.SecurityConfig;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.jboss.logging.Logger;

import java.time.Duration;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * Redisä¼šè¯ç®¡ç†å™¨å®ç°
 * <p>
 * åŸºäºRediså®ç°åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ï¼Œæ”¯æŒï¼š
 * <ul>
 *   <li>ä¼šè¯åˆ›å»ºä¸é”€æ¯</li>
 *   <li>åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢</li>
 *   <li>ä¼šè¯ç»­æœŸ</li>
 *   <li>å¼ºåˆ¶ä¸‹çº¿</li>
 * </ul>
 */
@ApplicationScoped
public class RedisSessionManager implements SessionManager {

    private static final Logger LOG = Logger.getLogger(RedisSessionManager.class);

    /** ä¼šè¯ç¼“å­˜Keyå‰ç¼€ */
    private static final String SESSION_KEY_PREFIX = "security:session:";

    /** ç”¨æˆ·ä¼šè¯ç´¢å¼•Keyå‰ç¼€ */
    private static final String USER_SESSION_KEY_PREFIX = "security:user:session:";

    @Inject
    CacheFacade cacheFacade;

    @Inject
    DistributedFacade distributedFacade;

    @Inject
    SecurityConfig securityConfig;

    @Override
    public void createSession(OnlineUser onlineUser) {
        String sessionId = generateSessionId();
        String sessionKey = SESSION_KEY_PREFIX + sessionId;
        String userSessionKey = USER_SESSION_KEY_PREFIX + onlineUser.userId();

        Duration sessionTimeout = securityConfig.session().timeout();

        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¼šè¯ï¼ˆå•è®¾å¤‡ç™»å½•åœºæ™¯ï¼‰
        if (securityConfig.session().singleDeviceLogin()) {
            destroyUserAllSessions(onlineUser.userId());
        }

        // 2. å­˜å‚¨ä¼šè¯
        cacheFacade.put(sessionKey, onlineUser, sessionTimeout);

        // 3. å»ºç«‹ç”¨æˆ·->ä¼šè¯çš„ç´¢å¼•
        cacheFacade.put(userSessionKey, sessionId, sessionTimeout);

        LOG.infov("Session created: sessionId={0}, userId={1}", sessionId, onlineUser.userId());
    }

    @Override
    public Optional<OnlineUser> getSession(String sessionId) {
        return cacheFacade.get(SESSION_KEY_PREFIX + sessionId, OnlineUser.class);
    }

    @Override
    public void destroySession(String sessionId) {
        Optional<OnlineUser> session = getSession(sessionId);
        if (session.isPresent()) {
            cacheFacade.invalidate(SESSION_KEY_PREFIX + sessionId);
            cacheFacade.invalidate(USER_SESSION_KEY_PREFIX + session.get().userId());
            LOG.infov("Session destroyed: sessionId={0}", sessionId);
        }
    }

    @Override
    public void renewSession(String sessionId) {
        Optional<OnlineUser> sessionOpt = getSession(sessionId);
        if (sessionOpt.isPresent()) {
            OnlineUser onlineUser = sessionOpt.get().touch();
            Duration sessionTimeout = securityConfig.session().timeout();
            cacheFacade.put(SESSION_KEY_PREFIX + sessionId, onlineUser, sessionTimeout);
        }
    }

    @Override
    public boolean existsByUserId(Long userId) {
        return cacheFacade.get(USER_SESSION_KEY_PREFIX + userId, String.class).isPresent();
    }

    @Override
    public void destroyUserAllSessions(Long userId) {
        Optional<String> sessionIdOpt = cacheFacade.get(USER_SESSION_KEY_PREFIX + userId, String.class);
        sessionIdOpt.ifPresent(this::destroySession);
    }

    @Override
    public List<OnlineUser> getOnlineUsers() {
        // è¿™é‡Œéœ€è¦ä½¿ç”¨Redis SCANå‘½ä»¤è·å–æ‰€æœ‰ä¼šè¯ï¼Œç®€åŒ–ç‰ˆç›´æ¥è¿”å›ç©º
        // å®é™…å®ç°éœ€è¦ç»´æŠ¤åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        return List.of();
    }

    @Override
    public long getOnlineUserCount() {
        return getOnlineUsers().size();
    }

    // ===========================
    // ç§æœ‰è¾…åŠ©æ–¹æ³•
    // ===========================

    private String generateSessionId() {
        return distributedFacade.nextIdStr();
    }
}
```

---

## 8. æ¥å£å±‚è®¾è®¡

### 8.1 ç™»å½•å‘½ä»¤

```java
package io.github.faustofan.admin.interfaces.command.auth;

/**
 * ç™»å½•å‘½ä»¤
 * <p>
 * å°è£…ç”¨æˆ·ç™»å½•è¯·æ±‚å‚æ•°ã€‚
 */
public record LoginCommand(
    String username,        // ç”¨æˆ·å
    String password,        // å¯†ç 
    String captchaCode,     // éªŒè¯ç 
    String captchaKey,      // éªŒè¯ç Key
    Long tenantId           // ç§Ÿæˆ·IDï¼ˆå¯é€‰ï¼‰
) {
    /**
     * éªŒè¯å‘½ä»¤å‚æ•°
     */
    public void validate() {
        if (username == null || username.isBlank()) {
            throw new IllegalArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        if (password == null || password.isBlank()) {
            throw new IllegalArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º");
        }
    }
}
```

### 8.2 è®¤è¯RESTèµ„æº

```java
package io.github.faustofan.admin.interfaces.rest.auth;

import io.github.faustofan.admin.application.dto.auth.LoginCommand;
import io.github.faustofan.admin.application.dto.auth.RefreshTokenCommand;
import io.github.faustofan.admin.domain.security.valueobject.LoginInfo;
import io.github.faustofan.admin.domain.security.valueobject.TokenPair;
import io.github.faustofan.admin.shared.security.facade.SecurityFacade;
import io.github.faustofan.admin.shared.web.dtos.R;
import jakarta.inject.Inject;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.HttpHeaders;
import jakarta.ws.rs.core.MediaType;
import org.jboss.logging.Logger;

/**
 * è®¤è¯RESTæ¥å£
 * <p>
 * æä¾›ç”¨æˆ·è®¤è¯ç›¸å…³çš„HTTPæ¥å£ï¼ŒåŒ…æ‹¬ç™»å½•ã€ç™»å‡ºã€åˆ·æ–°Tokenç­‰ã€‚
 */
@Path("/auth")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class AuthResource {

    private static final Logger LOG = Logger.getLogger(AuthResource.class);

    @Inject
    SecurityFacade securityFacade;

    /**
     * ç”¨æˆ·ç™»å½•
     *
     * @param command ç™»å½•å‘½ä»¤
     * @param headers HTTPå¤´éƒ¨ï¼ˆè·å–å®¢æˆ·ç«¯ä¿¡æ¯ï¼‰
     * @return ç™»å½•ä¿¡æ¯ï¼ˆåŒ…å«Tokenï¼‰
     */
    @POST
    @Path("/login")
    public R<LoginInfo> login(LoginCommand command, @Context HttpHeaders headers) {
        command.validate();

        String clientIp = headers.getHeaderString("X-Forwarded-For");
        String userAgent = headers.getHeaderString("User-Agent");

        LoginInfo loginInfo = securityFacade.login(command, clientIp, userAgent);

        return R.success(loginInfo);
    }

    /**
     * ç”¨æˆ·ç™»å‡º
     *
     * @return æ“ä½œç»“æœ
     */
    @POST
    @Path("/logout")
    public R<Void> logout() {
        securityFacade.logout();
        return R.success();
    }

    /**
     * åˆ·æ–°Token
     *
     * @param command åˆ·æ–°Tokenå‘½ä»¤
     * @return æ–°çš„Tokenå¯¹
     */
    @POST
    @Path("/refresh")
    public R<TokenPair> refreshToken(RefreshTokenCommand command) {
        TokenPair tokenPair = securityFacade.refreshToken(command.refreshToken());
        return R.success(tokenPair);
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
     *
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    @GET
    @Path("/info")
    public R<LoginInfo> getCurrentUser() {
        LoginInfo loginInfo = securityFacade.getCurrentUser();
        return R.success(loginInfo);
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·æƒé™åˆ—è¡¨
     *
     * @return æƒé™æ ‡è¯†åˆ—è¡¨
     */
    @GET
    @Path("/permissions")
    public R<java.util.List<String>> getPermissions() {
        java.util.List<String> permissions = securityFacade.getCurrentUserPermissions();
        return R.success(permissions);
    }
}
```

---

## 11. å®æˆ˜ä½¿ç”¨æŒ‡å— (Implementation Guide)

æœ¬ç« èŠ‚åŸºäºå®é™…å®Œæˆçš„ä»£ç å®ç°ï¼Œæä¾›å¼€å‘é›†æˆçš„å…·ä½“æŒ‡å¼•ã€‚

### 11.1 æ ¸å¿ƒç»„ä»¶æ¸…å•

å®é™…è½åœ°çš„ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

*   **æ ¸å¿ƒé—¨é¢**: `io.github.faustofan.admin.shared.security.facade.SecurityFacade`
*   **å®‰å…¨ä¸Šä¸‹æ–‡**: `io.github.faustofan.admin.shared.security.context.SecurityContextHolder`
*   **æ‹¦æˆªå™¨**: `io.github.faustofan.admin.shared.security.interceptor.SecurityInterceptor`
*   **æ³¨è§£**: 
    *   `@RequiresAuthentication`
    *   `@RequiresPermission`
    *   `@RequiresRole`
    *   `@Anonymous`
    *   `@Secured` (æ‹¦æˆªå™¨ç»‘å®š)

### 11.2 æ¥å£è°ƒç”¨ç¤ºä¾‹

#### 1. ç”¨æˆ·ç™»å½•

**è¯·æ±‚:**
`POST /auth/login`

```json
{
  "username": "admin",
  "password": "password123",
  "tenantId": 1
}
```

**å“åº”:**

```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    "tokenPair": {
      "accessToken": "eyJ...",
      "refreshToken": "eyJ...",
      "accessTokenExpireTime": "2024-01-01T12:00:00Z",
      "refreshTokenExpireTime": "2024-01-02T12:00:00Z"
    },
    "userId": 1,
    "username": "admin",
    ...
  }
}
```

#### 2. åˆ·æ–° Token

**è¯·æ±‚:**
`POST /auth/refresh`

```json
{
  "refreshToken": "eyJ..."
}
```

### 11.3 åç«¯å¼€å‘æŒ‡å—

#### 1. å¼€å¯æ¥å£æƒé™æ§åˆ¶

åœ¨ REST Resource ç±»æˆ–æ–¹æ³•ä¸Šï¼š

1.  **å¿…é¡»**æ·»åŠ  `@Secured` æ³¨è§£ä»¥æ¿€æ´»æ‹¦æˆªå™¨ã€‚
2.  ç»„åˆä½¿ç”¨æƒé™æ³¨è§£ã€‚

**ç¤ºä¾‹:**

```java
@Path("/system/users")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Secured // <--- å…³é”®ï¼šæ¿€æ´»å®‰å…¨æ‹¦æˆªå™¨
public class UserResource {

    @Inject
    SecurityFacade securityFacade;

    // åœºæ™¯1ï¼šä»…éœ€ç™»å½•
    @GET
    @Path("/profile")
    @RequiresAuthentication
    public ApiResponse<UserInfo> getProfile() {
        Long userId = SecurityContextHolder.requireCurrentUserId();
        // ...
    }

    // åœºæ™¯2ï¼šéœ€è¦ç‰¹å®šæƒé™
    @POST
    @RequiresPermission("system:user:add")
    public ApiResponse<Void> createUser(UserCommand cmd) {
        // ...
    }

    // åœºæ™¯3ï¼šå…è®¸åŒ¿åè®¿é—®ï¼ˆå¿½ç•¥ç±»çº§åˆ«çš„ @Secured æ£€æŸ¥ï¼‰
    @GET
    @Path("/public-config")
    @Anonymous
    public ApiResponse<Config> getPublicConfig() {
        // ...
    }
}
```

#### 2. æ‰‹åŠ¨è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

åœ¨ä»»ä½• Bean ä¸­ï¼ˆä¸ä»…ä»…æ˜¯ Controllerï¼‰ï¼š

```java
// 1. è·å–å½“å‰ Token ä¸­çš„ Claims
Optional<TokenClaims> claims = SecurityContextHolder.getContext().getTokenClaims();

// 2. è·å–ç”¨æˆ·ID (å¦‚æœæœªç™»å½•ä¼šæŠ›å¼‚å¸¸)
Long userId = SecurityContextHolder.requireCurrentUserId();

// 3. æ£€æŸ¥æƒé™
if (SecurityContextHolder.hasPermission("system:user:export")) {
    // ...
}
```

### 11.4 é…ç½®æ–‡ä»¶è¯´æ˜

åœ¨ `application.yaml` ä¸­é…ç½®å®‰å…¨å‚æ•°ï¼š

```yaml
app:
  security:
    jwt:
      sign-key: "..."      # ç­¾åå¯†é’¥ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ç§é’¥æ–‡ä»¶)
      issuer: "admin-server"
      access-token-expire: PT2H    # 2å°æ—¶
      refresh-token-expire: PT7D   # 7å¤©
    
    session:
      single-device-login: true    # å¼€å¯å•è®¾å¤‡ç™»å½•é™åˆ¶
      timeout: PT24H               # Redisä¼šè¯è¿‡æœŸæ—¶é—´
    
    password:
      max-retry-count: 5           # å¯†ç é‡è¯•æ¬¡æ•°
      lock-time: PT30M             # é”å®šæ—¶é—´
    
    whitelist:
      enable-defaults: true        # å¼€å¯é»˜è®¤ç™½åå• (/auth/login, /swagger-ui/** ç­‰)
      paths:                       # è‡ªå®šä¹‰ç™½åå•
        - "/public/**"
        - "/callback/*"
```

### 11.5 æ‰©å±•å¼€å‘æŒ‡å¼•

1.  **æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼**:
    *   å®ç° `Authenticator` æ¥å£ (ä¾‹å¦‚ `LdapAuthenticator`, `OAuth2Authenticator`)ã€‚
    *   åœ¨ `SecurityFacade` ä¸­æ ¹æ®ç±»å‹é€‰æ‹©å¯¹åº”çš„è®¤è¯å™¨ã€‚

2.  **è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘**:
    *   ä¿®æ”¹ `JimmerPermissionChecker` æˆ–å®ç°æ–°çš„ `PermissionChecker`ã€‚

3.  **ç›‘å¬å®‰å…¨äº‹ä»¶**:
    *   åˆ›å»º CDI Bean å¹¶ä½¿ç”¨ `@Observes` ç›‘å¬ `DomainEvent<LoginEvent>` ç­‰äº‹ä»¶ï¼Œå®ç°æ—¥å¿—è®°å½•æˆ–é€šçŸ¥ã€‚

```java
@ApplicationScoped
public class SecurityAuditListener {
    
    public void onLogin(@ObservesAsync DomainEvent<LoginEvent> event) {
        LoginEvent payload = event.getPayload();
        if (payload.success()) {
            // è®°å½•ç™»å½•æˆåŠŸæ—¥å¿—...
        }
    }
}
```
