apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build-native
  namespace: tekton-pipelines
spec:
  params:
  - description: Name of the image to build
    name: IMAGE
    type: string
  - default: latest
    description: Tag of the image to build
    name: TAG
    type: string
  steps:
  - computeResources: {}
    image: busybox
    name: create-dockerfile
    script: |
      #!/bin/sh
      set -e

      # Find native binary
      BINARY=$(find source/target -name '*-runner' -type f | head -1)
      BINARY_NAME=$(basename $BINARY)

      echo "Found binary: $BINARY"

      # Create Dockerfile
      cat > Dockerfile <<DOCKERFILE_EOF
      FROM registry.access.redhat.com/ubi8/ubi-minimal:8.10

      WORKDIR /work/

      # Copy native binary
      COPY source/target/$BINARY_NAME /work/application

      # Set executable permissions
      RUN chmod 775 /work/application

      EXPOSE 8080
      USER 1001

      CMD ["/work/application", "-Dquarkus.http.host=0.0.0.0"]
      DOCKERFILE_EOF

      echo "=== Dockerfile created ==="
      cat Dockerfile
    workingDir: $(workspaces.source.path)
  - args:
    - --dockerfile=Dockerfile
    - --context=.
    - --destination=10.43.193.98:5000/$(params.IMAGE):$(params.TAG)
    - --insecure
    - --skip-tls-verify
    - --custom-platform=linux/amd64
    command:
    - /kaniko/executor
    computeResources: {}
    image: gcr.io/kaniko-project/executor:latest
    name: build-and-push
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
