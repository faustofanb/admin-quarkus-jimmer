apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: maven-build
  namespace: tekton-pipelines
spec:
  description: Build with Maven using Nexus mirror
  params:
  - default: clean package -DskipTests
    description: Maven goals to execute
    name: GOALS
    type: string
  steps:
  - computeResources: {}
    env:
    - name: MAVEN_OPTS
      value: -Dmaven.repo.local=$(workspaces.source.path)/.m2
    image: maven:3.9-eclipse-temurin-21
    name: mvn-build
    script: |
      #!/bin/bash
      set -e

      # 使用 Nexus settings.xml
      mvn -s $(workspaces.maven-settings.path)/settings.xml $(params.GOALS)

      echo "=== Build completed ==="
      ls -la target/ || echo "No target directory"
    workingDir: $(workspaces.source.path)/source
  workspaces:
  - description: The workspace containing the source code
    name: source
  - description: Maven settings.xml
    name: maven-settings
