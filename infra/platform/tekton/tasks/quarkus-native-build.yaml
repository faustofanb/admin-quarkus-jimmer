apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: quarkus-native-build
  namespace: tekton-pipelines
spec:
  steps:
  - computeResources:
      limits:
        cpu: "8"
        memory: 16Gi
      requests:
        cpu: "4"
        memory: 8Gi
    image: quay.io/quarkus/ubi-quarkus-mandrel-builder-image:jdk-21
    name: mvn-native-build
    script: |
      #!/bin/bash
      set -e

      echo "=== Starting Native Build ==="
      echo "Working directory: $(pwd)"
      ls -la

      # Fix permissions
      chown -R 1000:1000 .

      # Configure Maven settings
      MAVEN_SETTINGS=""
      if [ -f $(workspaces.maven-settings.path)/settings.xml ]; then
        cp $(workspaces.maven-settings.path)/settings.xml /tmp/settings.xml
        MAVEN_SETTINGS="-s /tmp/settings.xml"
      fi

      # Configure Maven Local Repo (Cache)
      LOCAL_REPO_PATH="$(workspaces.source.path)/.m2"
      if [ -d "$(workspaces.maven-local-repo.path)" ]; then
         echo "Using persistent maven cache: $(workspaces.maven-local-repo.path)"
         LOCAL_REPO_PATH="$(workspaces.maven-local-repo.path)/.m2"
      fi
      export MAVEN_OPTS="-Dmaven.repo.local=$LOCAL_REPO_PATH -Xmx12G"

      # Check mvnw
      if [ ! -x ./mvnw ]; then
        chmod +x ./mvnw
      fi

      # Execute native build
      echo "Starting Maven build..."
      ./mvnw clean package -Pnative -DskipTests \
        -Dquarkus.native.native-image-xmx=12g \
        $MAVEN_SETTINGS

      echo "=== Native Build Complete ==="
      ls -lh target/

      # Verify native binary
      BINARY=$(find target -name '*-runner' -type f)
      if [ -n "$BINARY" ]; then
        echo "✅ Native binary created successfully:"
        echo "   Path: $BINARY"
        ls -lh $BINARY
        chmod +x $BINARY
        if [ -x "$BINARY" ]; then
          echo "   Executable: YES"
        fi
      else
        echo "❌ ERROR: Native binary not found!"
        exit 1
      fi
    securityContext:
      runAsUser: 0
    workingDir: $(workspaces.source.path)/source
  workspaces:
  - name: source
  - name: maven-settings
  - name: maven-local-repo
    optional: true
