apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-gitops-repo
  namespace: tekton-pipelines
spec:
  params:
  - name: gitops-repo-url
    type: string
  - name: image-name
    type: string
  - name: image-tag
    type: string
  - name: overlay-path
    type: string
  - default: Tekton Bot
    name: git-username
    type: string
  - default: tekton@example.com
    name: git-email
    type: string
  steps:
  - env:
    - name: GITEA_USERNAME
      valueFrom:
        secretKeyRef:
          key: username
          name: gitea-credentials
    - name: GITEA_TOKEN
      valueFrom:
        secretKeyRef:
          key: token
          name: gitea-credentials
    image: alpine/git:latest
    name: clone-and-update
    script: |
      #!/bin/sh
      set -e
      
      # Setup Git
      git config --global user.name "$(params.git-username)"
      git config --global user.email "$(params.git-email)"
      
      # Clone GitOps repository
      echo "Cloning GitOps repository..."
      cd $(workspaces.gitops-source.path)
      git clone $(params.gitops-repo-url) repo
      cd repo
      
      # Setup credentials for push
      GIT_URL=$(params.gitops-repo-url)
      GIT_URL_WITH_AUTH=$(echo "$GIT_URL" | sed "s|http://|http://${GITEA_USERNAME}:${GITEA_TOKEN}@|g")
      git remote set-url origin "$GIT_URL_WITH_AUTH"
      
      echo "Navigating to overlay: $(params.overlay-path)"
      cd $(params.overlay-path)
      
      if [ ! -f kustomization.yaml ]; then
        echo "ERROR: kustomization.yaml not found at $(pwd)"
        ls -la
        exit 1
      fi
      
      echo "Updating image tag to $(params.image-tag)..."
      sed -i "s|newTag:.*|newTag: \"$(params.image-tag)\"|g" kustomization.yaml
      
      echo "Diff:"
      git diff kustomization.yaml
      
      git add kustomization.yaml
      if git commit -m "chore(gitops): update $(params.image-name) image tag to $(params.image-tag)"; then
        # Push with credentials
        cd $(workspaces.gitops-source.path)/repo
        git push origin main
        echo "✅ GitOps repository updated"
      else
        echo "ℹ️  No changes to commit"
      fi
    workingDir: /tmp
  workspaces:
  - name: gitops-source
